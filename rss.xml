<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
   <title>TJ (Thaddeus Jiang)</title>
   <link>https://thaddeusjiang.com</link>
   <description>专注；分享；寻找。</description>
   <item>
      <title>2023-08-25 最近常常考虑找个心理医生治疗一下</title>
      <link>https://thaddeusjiang.com/2023-08-25-zui-jin-chang-chang-kao-lv-zhao-ge-xin-li-yi-sheng-zhi-liao-yi-xia</link>
			<description><![CDATA[
<div class="container">
    <div class="column is-6-desktop is-offset-3-desktop is-8 is-offset-2 my-4">
      <nav aria-label="main navigation" class="navbar" role="navigation">
        <div class="navbar-brand">
            <a href="./">
                <h1 class="title">TJ (Thaddeus Jiang)</h1>
                <p class="subtitle">专注；分享；寻找。</p>
            </a>
        </div>
     </nav>
    </div>
  </div>


<div class="container mt-4">
  <div class="column is-6-desktop is-offset-3-desktop is-8 is-offset-2">
      <div>
          <div class="block content blog">
            <h1 class="subtitle">2023-08-25 最近常常考虑找个心理医生治疗一下</h1>
            <hr>

            <p>我有两个心结一直无法解开，虽然我很想放下，但是它们总是闯进我的梦和大脑里，超级烦人。</p><p>第一个心结是：我经常梦见自己在大四从大学退学，回高中复读去了，没有拿到大学毕业证。</p><p>我经常梦见自己在大四从大学退学，回高中复读去了，梦里我总是邻近高考才发现自己现在的实力连大连理工都考不上了，开始后悔自己为什么选择复读重新高考。明明已经在大学读了3年，最后一年实习结束后就能稳稳地拿到毕业证而自己却放弃了。每次都被这个梦折腾到身心疲惫，每次都要到梦快醒的时候我才意识到自己在现实世界其实已经顺利毕业了。</p><p>😂 何必呢？</p><p>虽然醒着的时候我觉得自己已经放下的大学去了大连理工大学软件学院这个心结，而且学习软件貌似是一个非常不错的选择，市场需求大，待遇高，自己也擅长。
但是在梦里它总是出现，总来折磨我，好烦啊。我都已经从大学毕业 8 年了，而且这些年因为大连理工也算是不错的学校，软件工程是比较有市场的专业，我也过的不错，没有过的很惨。</p><p>为什么梦里这个心结总来折磨我，我真的想不通。醒着的时候我觉得自己真的已经不介意了啊。</p><p>我的第二个心结是：</p><p>这个心结比较隐私，只有我老婆和几个朋友知道，我暂时还没有勇气说出来。其实我很想和现在常联系的几个朋友聊聊这个心结的，但是现在年纪大了，没有年轻时那么勇敢了，所以有时候觉得年纪大了以后朋友之间也有不能说的秘密。成长让人变得更孤独，更不幸。
我觉得很烦，我不知道什么时候能克服这个心结，说不定一生都无法克服吧。
有时我安慰自己，如果这个世界足够包容，没有圣母婊，没有道德警察，这个心结其实也不是什么大问题，没有伤害到任何人，对我自己也没有任何负面影响。</p><blockquote><div>BTW 我不是同性恋，不用瞎猜，哈哈哈</div></blockquote><p>实在不行，真的应该去寻求一下心理治疗，要是被这两件破事继续折磨下午可太烦了。</p><p>以上
</p>
          </div>          
      </div>
  </div>
</div>     


]]></description>
      <pubDate>Fri, 25 August 2023 4:13:22 -00:00</pubDate>
			<guid>https://thaddeusjiang.com/2023-08-25-zui-jin-chang-chang-kao-lv-zhao-ge-xin-li-yi-sheng-zhi-liao-yi-xia</guid>      
   </item>

   <item>
      <title>2023-08-24 JS/TS number 格格不入</title>
      <link>https://thaddeusjiang.com/2023-08-24-js-ts-number-ge-ge-bu-ru</link>
			<description><![CDATA[
<div class="container">
    <div class="column is-6-desktop is-offset-3-desktop is-8 is-offset-2 my-4">
      <nav aria-label="main navigation" class="navbar" role="navigation">
        <div class="navbar-brand">
            <a href="./">
                <h1 class="title">TJ (Thaddeus Jiang)</h1>
                <p class="subtitle">专注；分享；寻找。</p>
            </a>
        </div>
     </nav>
    </div>
  </div>


<div class="container mt-4">
  <div class="column is-6-desktop is-offset-3-desktop is-8 is-offset-2">
      <div>
          <div class="block content blog">
            <h1 class="subtitle">2023-08-24 JS/TS number 格格不入</h1>
            <hr>

            <blockquote class="tc-quote tc-big-quote"><p>imo: TypeScript number 类型作用范围模糊，JavaScript number 很容易产生 bug，ES bigint 限制太多，long.js 能不用就别用。
</p><cite>TJ</cite></blockquote><p>TypeScript 的 number 类型因为需要兼容 JavaScript，所以没有 int32 int64 等细分类型，数值范围也和其他静态语言不一样，使得 TypeScript number 与其他编程语言格格不入。</p><p>分享几个我遇到的问题以及解决方案：</p><h3 class="">1. JS/TS number 全身都是 bug</h3><p>JS/TS number 因为要同时兼容 int float double 导致它的精度很迷，与强类型工具（如 RDB, protobuf）的数值范围上有差异，非常容易产生 bug。</p><p>JS 最大安全整数（能够精确表示的整数）为 9,007,199,254,740,991（2<sup>53</sup> - 1），远小于 int64 (2<sup>63</sup> - 1)。所以如果你在 RDB 中使用 int64 类型，在 JS 中就会溢出。</p><p>Example: 2<sup>64</sup>-1 is 1844674407370955<strong>1615</strong> but in JavaScript it evaluates to 1844674407370955<strong>2000</strong>.</p><blockquote><div>使用 long.js 可以弥补这个设计缺陷。</div></blockquote><p>但是 long.js 也有问题，基本上和 bigint 的问题一样，我们一起说。</p><h3 class="">2. JS/TS bigint 限制超多</h3><p>bigint 虽然是整数，但是在使用上有很多限制，例如：</p><ol><li>BigInt 与 Number 转换会损失精度</li><li>BigInt 在 JSON.stringify() 会引发 TypeError</li><li>BigInt 不能使用 Math 中方法</li></ol><p>天呐🤷，这么多限制，还不容不用呢。反正我从来不用 bigint。</p><p>如果真的需要处理超大数值，我推荐使用 bignumber.js，我可不想自己写数值运算，bignumber.js 提供了很多开箱即用的方法：</p><h2 class="">3. int32 int64 对应 TS 类型没有统一标准</h2><p>Prisma scheme 支持 BigInt 类型，对应 TS BigInt 类型</p><p>Protocol Buffers 的 int32 int64 类型分别对应 TS number 和 Long</p><p>如果你同时使用 Prisma BigInt 和 protobuf int64 的话，你带代码中就会出现大量相互转换的 utils，类似下面这种：</p><blockquote><div>👇这些代码都是我从其他人的代码中 copy 过来的，不是我写的，我也永远不用写这种代码。</div></blockquote><pre class="hljs"><code class="ts hljs"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BigIntUtil</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">toNumber</span>(<span class="hljs-attr">b</span>: bigint): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">const</span> n = <span class="hljs-built_in">parseInt</span>(b.<span class="hljs-title function_">toString</span>());
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Number</span>.<span class="hljs-title function_">isSafeInteger</span>(n)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(
        <span class="hljs-string">&#x27;Fail to cast bigint to number. Value is out of safe integer range.&#x27;</span>,
      );
    }
    <span class="hljs-keyword">return</span> n;
  }

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">from</span>(<span class="hljs-attr">v</span>: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span> | bigint): bigint {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> v === <span class="hljs-string">&#x27;bigint&#x27;</span>) {
      <span class="hljs-keyword">return</span> v;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">BigInt</span>(v);
  }
}</code></pre><pre class="hljs"><code class="ts hljs"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Long</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;long&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LongUtil</span> {
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">fromBigInt</span>(<span class="hljs-attr">num</span>: bigint): <span class="hljs-title class_">Long</span>;
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">fromBigInt</span>(<span class="hljs-attr">num</span>: bigint | <span class="hljs-literal">undefined</span> | <span class="hljs-literal">null</span>): <span class="hljs-title class_">Long</span> | <span class="hljs-literal">undefined</span>;
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">fromBigInt</span>(<span class="hljs-attr">num</span>: bigint | <span class="hljs-literal">undefined</span> | <span class="hljs-literal">null</span>): <span class="hljs-title class_">Long</span> | <span class="hljs-literal">undefined</span> {
    <span class="hljs-keyword">if</span> (num === <span class="hljs-literal">undefined</span> || num === <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Long</span>.<span class="hljs-title function_">fromNumber</span>(<span class="hljs-title class_">Number</span>(num));
  }

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">toBigInt</span>(<span class="hljs-attr">num</span>: <span class="hljs-title class_">Long</span>): bigint;
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">toBigInt</span>(<span class="hljs-attr">num</span>: <span class="hljs-title class_">Long</span> | <span class="hljs-literal">undefined</span> | <span class="hljs-literal">null</span>): bigint | <span class="hljs-literal">undefined</span>;
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">toBigInt</span>(<span class="hljs-attr">num</span>: <span class="hljs-title class_">Long</span> | <span class="hljs-literal">undefined</span> | <span class="hljs-literal">null</span>): bigint | <span class="hljs-literal">undefined</span> {
    <span class="hljs-keyword">if</span> (num === <span class="hljs-literal">undefined</span> || num === <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">BigInt</span>(num.<span class="hljs-title function_">toNumber</span>());
  }
}</code></pre><pre class="hljs"><code class="ts hljs"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonUtil</span> {
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">stringify</span>(<span class="hljs-attr">data</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data, <span class="hljs-function">(<span class="hljs-params">k, v</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> v === <span class="hljs-string">&#x27;bigint&#x27;</span>) {
        <span class="hljs-keyword">return</span> v.<span class="hljs-title function_">toString</span>();
      }
      <span class="hljs-keyword">return</span> v;
    });
  }
}</code></pre><p>你有关于 JS/TS number 的故事吗？欢迎与我分享。</p><p>refs:</p><ul><li><a class="tc-tiddlylink-external" href="https://www.npmjs.com/package/long" rel="noopener noreferrer" target="_blank">long.js</a></li><li><a class="tc-tiddlylink-external" href="https://www.npmjs.com/package/bignumber.js" rel="noopener noreferrer" target="_blank">bignumber.js</a></li><li><a class="tc-tiddlylink-external" href="https://www.prisma.io/docs/concepts/components/prisma-client/working-with-fields#working-with-bigint" rel="noopener noreferrer" target="_blank">Prisma BigInt</a></li><li><a class="tc-tiddlylink-external" href="https://protobuf.dev/programming-guides/proto3/" rel="noopener noreferrer" target="_blank">protobuf int64</a></li></ul>
          </div>          
      </div>
  </div>
</div>     


]]></description>
      <pubDate>Thu, 24 August 2023 13:44:6 -00:00</pubDate>
			<guid>https://thaddeusjiang.com/2023-08-24-js-ts-number-ge-ge-bu-ru</guid>      
   </item>

   <item>
      <title>2023-08-22 error handling</title>
      <link>https://thaddeusjiang.com/2023-08-22-error-handling</link>
			<description><![CDATA[
<div class="container">
    <div class="column is-6-desktop is-offset-3-desktop is-8 is-offset-2 my-4">
      <nav aria-label="main navigation" class="navbar" role="navigation">
        <div class="navbar-brand">
            <a href="./">
                <h1 class="title">TJ (Thaddeus Jiang)</h1>
                <p class="subtitle">专注；分享；寻找。</p>
            </a>
        </div>
     </nav>
    </div>
  </div>


<div class="container mt-4">
  <div class="column is-6-desktop is-offset-3-desktop is-8 is-offset-2">
      <div>
          <div class="block content blog">
            <h1 class="subtitle">2023-08-22 error handling</h1>
            <hr>

            <p>对于 error handling，我的风格碰巧和 Ruby 作者 Matz 一致，虽然是巧合，但是增加了我的信心。</p><p>先说 error handling 需要解决哪些问题？</p><ol><li>不能放任 error 使其导致程序崩溃</li><li>不能让 error handling 多到影响原本的功能</li></ol><p>我常用的编程语言有 TypeScript 和 Elixir，Elixir 不用说了，我很喜欢它的 error handling 机制。</p><p>我主要分享一下我自己使用 TypeScript 时的 error handling 风格。</p><h3 class="">1. 80% 的情况下，我会直接使用 try-catch 处理 Exception，不用其他奇技淫巧</h3><h3 class="">2. 我会尽量避免 Nested try blocks，形如：</h3><pre class="hljs"><code class="js hljs"><span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;oops&quot;</span>);
  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;finally&quot;</span>);
  }
} <span class="hljs-keyword">catch</span> (ex) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;outer&quot;</span>, ex.<span class="hljs-property">message</span>);
}</code></pre><p>为了避免嵌套 try blocks，我会参考 Elixir/golang/Swift 的方式返回一个数组包含 [isError, data/error]</p><p>形如：</p><pre class="hljs"><code class="js hljs"><span class="hljs-comment">// </span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">doSomething</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">return</span> [<span class="hljs-literal">false</span>, data]
  } <span class="hljs-keyword">catch</span>(error) {
    <span class="hljs-keyword">return</span> [<span class="hljs-literal">true</span>, error]
  }
}

<span class="hljs-keyword">const</span> [isError, data] = <span class="hljs-title function_">doSomething</span>()
<span class="hljs-keyword">if</span>(isError) {
  <span class="hljs-comment">// data is error</span>
  <span class="hljs-comment">// your fallback</span>
}
<span class="hljs-comment">// data is expected data</span>
<span class="hljs-comment">// next ...</span></code></pre><p>supabase-js 和 zod 也采用了类似的风格，只是细节不太一样，这也增强了我的信心。</p><pre class="hljs"><code class="js hljs"><span class="hljs-comment">// supabase-js </span>
<span class="hljs-keyword">const</span> { data, error } = <span class="hljs-keyword">await</span> supabase
  .<span class="hljs-title function_">from</span>(<span class="hljs-string">&#x27;countries&#x27;</span>)
  .<span class="hljs-title function_">select</span>()</code></pre><pre class="hljs"><code class="js hljs"><span class="hljs-comment">// zod .safeParse</span>
stringSchema.<span class="hljs-title function_">safeParse</span>(<span class="hljs-number">12</span>);
<span class="hljs-comment">// =&gt; { success: false; error: ZodError }</span>

stringSchema.<span class="hljs-title function_">safeParse</span>(<span class="hljs-string">&quot;billie&quot;</span>);
<span class="hljs-comment">// =&gt; { success: true; data: &#x27;billie&#x27; }</span></code></pre><p>为什么我用 Array 而不是 Object 作为返回值？因为我觉得 ES6 以后数组取值也很简单。</p><h3 class="">3. 我不会强迫症似的穷举所有的 Exception 类型</h3><pre class="hljs"><code class="js hljs"><span class="hljs-comment">// good</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doSomething</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Data</span>&gt;

<span class="hljs-comment">// bad</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doSomething</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Data</span> 
      | <span class="hljs-title class_">RpcException</span>
      | <span class="hljs-title class_">ChargeFeeHasNotBeenPaidException</span>
      | <span class="hljs-title class_">BadRequestException</span>
      | <span class="hljs-title class_">UnusableFacilityException</span>
      | <span class="hljs-title class_">NotBusinessDayException</span>&gt;</code></pre><p>当然，npm package, public library 除外。</p><h3 class="">4. 我不会让 Exception 不能导致整个 App 崩溃</h3><p>MVC 风格的 web server app 的 exception 最好控制在 controller 层，不要因为个别的 API 异常导致整个 App 崩溃或者重启。</p><p>类似 Remix.run 这样的框架甚至可以将 exception 控制在 UI component 级别，不过我不过分强求，只要别让整个 App 崩溃就行。</p><h3 class="">5. 我会适当记录 Exception log</h3><p>refs</p><ul><li><a class="tc-tiddlylink-external" href="https://supabase.com/docs/reference/javascript/select" rel="noopener noreferrer" target="_blank">supabse-js error handling</a></li><li><a class="tc-tiddlylink-external" href="https://zod.dev/?id=safeparse" rel="noopener noreferrer" target="_blank">zod.dev error handling</a></li></ul><p>备注：</p><blockquote><div>这是我的个人风格，不奢求成为主流，只希望将来有机会合作的朋友能事先了解我的个人风格。</div></blockquote>
          </div>          
      </div>
  </div>
</div>     


]]></description>
      <pubDate>Tue, 22 August 2023 1:13:55 -00:00</pubDate>
			<guid>https://thaddeusjiang.com/2023-08-22-error-handling</guid>      
   </item>

</channel>
</rss>
